<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AVO Carbon - Dashboard Métaux & FX</title>
    <link
      rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/STS-Engineer/LME_Dashboard/main/templates/Gemini_Generated_Image_gc66sygc66sygc66.png"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-gradient-start: #f5f7fa;
        --bg-gradient-end: #c3cfe2;
        --card-bg: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #7f8c8d;
        --primary-color: #0066b2;
        --primary-dark: #004d8c;
        --success-color: #27ae60;
        --success-dark: #229954;
        --danger-color: #e74c3c;
        --border-color: #ecf0f1;
        --border-hover: #bdc3c7;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 6px 12px rgba(0, 0, 0, 0.15);
        --transition-speed: 0.3s;
      }

      [data-theme="dark"] {
        --bg-gradient-start: #1a1a2e;
        --bg-gradient-end: #16213e;
        --card-bg: #0f3460;
        --text-primary: #e4e4e4;
        --text-secondary: #b0b0b0;
        --border-color: #1e3a5f;
        --border-hover: #2e5a8f;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 6px 12px rgba(0, 0, 0, 0.5);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        min-height: 100vh;
        padding: 20px;
        transition: background var(--transition-speed) ease;
        position: relative;
      }

      /* Animated background particles */
      .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--primary-color);
        border-radius: 50%;
        opacity: 0.3;
        animation: float 20s infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) translateX(0);
        }
        33% {
          transform: translateY(-100vh) translateX(50px);
        }
        66% {
          transform: translateY(-200vh) translateX(-50px);
        }
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      /* Dark Mode Toggle */
      .theme-toggle {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        background: var(--card-bg);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--transition-speed) ease;
        border: 3px solid var(--primary-color);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(0, 102, 178, 0.4);
        }
        50% {
          box-shadow: 0 0 0 20px rgba(0, 102, 178, 0);
        }
      }

      .theme-toggle:hover {
        transform: rotate(180deg) scale(1.1);
        animation: none;
      }

      .theme-toggle i {
        font-size: 24px;
        color: var(--primary-color);
        transition: all var(--transition-speed) ease;
      }

      /* Header */
      .header {
        background: var(--card-bg);
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideDown 0.5s ease;
        transition: all var(--transition-speed) ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .logo {
        height: 60px;
        animation: logoFloat 3s ease-in-out infinite;
      }

      @keyframes logoFloat {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .header-title {
        font-size: 28px;
        color: var(--text-primary);
        font-weight: 600;
        transition: color var(--transition-speed) ease;
      }

      .last-update {
        color: var(--text-secondary);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color var(--transition-speed) ease;
      }

      .last-update i {
        animation: clockTick 1s ease-in-out infinite;
      }

      @keyframes clockTick {
        0%,
        100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(10deg);
        }
        75% {
          transform: rotate(-10deg);
        }
      }

      /* Tabs */
      .page-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        animation: slideDown 0.6s ease;
      }

      .page-tab {
        flex: 1;
        text-align: center;
        padding: 10px 15px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all var(--transition-speed) ease;
        position: relative;
        overflow: hidden;
      }

      .page-tab::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s ease;
      }

      .page-tab:hover::before {
        left: 100%;
      }

      .page-tab:hover {
        background: var(--card-bg);
        box-shadow: var(--shadow-sm);
        transform: translateY(-2px);
      }

      .page-tab.active {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 8px rgba(0, 102, 178, 0.3);
        transform: scale(1.02);
      }

      .page-tab i {
        transition: transform var(--transition-speed) ease;
      }

      .page-tab:hover i {
        transform: scale(1.2);
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        transition: all var(--transition-speed) ease;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .card-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .card-title {
        font-size: 20px;
        color: var(--text-primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: color var(--transition-speed) ease;
      }

      /* Statistics Section */
      .stats-section {
        background: var(--card-bg);
        padding: 20px 25px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        transition: all var(--transition-speed) ease;
        animation: fadeIn 0.7s ease;
      }

      .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .stats-summary {
        font-size: 14px;
        color: var(--text-secondary);
        transition: color var(--transition-speed) ease;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--card-bg) 0%,
          var(--bg-gradient-start) 100%
        );
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-speed) ease;
        animation: scaleIn 0.5s ease;
        animation-fill-mode: backwards;
        border: 1px solid var(--border-color);
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .stat-card:nth-child(1) {
        animation-delay: 0.1s;
      }
      .stat-card:nth-child(2) {
        animation-delay: 0.2s;
      }
      .stat-card:nth-child(3) {
        animation-delay: 0.3s;
      }
      .stat-card:nth-child(4) {
        animation-delay: 0.4s;
      }

      .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-lg);
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .stat-title {
        color: var(--text-secondary);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: color var(--transition-speed) ease;
      }

      .stat-icon {
        font-size: 24px;
        color: var(--primary-color);
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        transition: color var(--transition-speed) ease;
      }

      .stat-change {
        margin-top: 10px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 600;
      }

      .change-positive {
        color: var(--success-color);
        animation: priceUp 0.5s ease;
      }

      .change-negative {
        color: var(--danger-color);
        animation: priceDown 0.5s ease;
      }

      @keyframes priceUp {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      @keyframes priceDown {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(3px);
        }
      }

      /* Filters Section */
      .filters-section {
        background: var(--card-bg);
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        transition: all var(--transition-speed) ease;
        animation: fadeIn 0.8s ease;
      }

      .filters-section:hover {
        box-shadow: var(--shadow-lg);
      }

      .filters-title {
        font-size: 18px;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: color var(--transition-speed) ease;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
        animation: slideUp 0.5s ease;
        animation-fill-mode: backwards;
      }

      .filter-group:nth-child(1) {
        animation-delay: 0.1s;
      }
      .filter-group:nth-child(2) {
        animation-delay: 0.2s;
      }
      .filter-group:nth-child(3) {
        animation-delay: 0.3s;
      }
      .filter-group:nth-child(4) {
        animation-delay: 0.4s;
      }
      .filter-group:nth-child(5) {
        animation-delay: 0.5s;
      }
      .filter-group:nth-child(6) {
        animation-delay: 0.6s;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .filter-label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: color var(--transition-speed) ease;
      }

      .filter-group:focus-within .filter-label {
        color: var(--primary-color);
      }

      .filter-input,
      .filter-select {
        padding: 12px 15px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 14px;
        color: var(--text-primary);
        transition: all var(--transition-speed) ease;
        background: var(--card-bg);
      }

      .filter-input:hover,
      .filter-select:hover {
        border-color: var(--border-hover);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transform: translateY(-1px);
      }

      .filter-input:focus,
      .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(0, 102, 178, 0.1);
        transform: translateY(-2px);
      }

      .filter-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230066b2' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 35px;
      }

      .filter-group.active::before {
        content: "";
        position: absolute;
        top: 0;
        left: -10px;
        width: 3px;
        height: 100%;
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        border-radius: 3px;
        animation: slideInLeft 0.3s ease;
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-color);
      }

      .filter-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #e8f4fd 0%, #d4e9f7 100%);
        color: var(--primary-color);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        animation: popIn 0.3s ease;
        transition: all var(--transition-speed) ease;
      }

      [data-theme="dark"] .filter-badge {
        background: linear-gradient(
          135deg,
          rgba(0, 102, 178, 0.2) 0%,
          rgba(0, 77, 140, 0.3) 100%
        );
        color: #5dade2;
      }

      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .filter-badge:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-sm);
      }

      .filter-badge .remove-filter {
        cursor: pointer;
        font-size: 14px;
        opacity: 0.7;
        transition: all 0.2s ease;
      }

      .filter-badge .remove-filter:hover {
        opacity: 1;
        transform: rotate(90deg);
      }

      .reset-filters-btn {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid var(--border-color);
        padding: 12px 25px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all var(--transition-speed) ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .reset-filters-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(0, 102, 178, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s ease, height 0.4s ease;
      }

      .reset-filters-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .reset-filters-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
      }

      .reset-filters-btn i {
        transition: transform var(--transition-speed) ease;
      }

      .reset-filters-btn:hover i {
        transform: rotate(360deg);
      }

      .btn-success,
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--success-color) 0%,
          var(--success-dark) 100%
        );
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all var(--transition-speed) ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
      }

      .btn-success::before,
      .btn-primary::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn-success:hover::before,
      .btn-primary:hover::before {
        width: 300px;
        height: 300px;
      }

      .btn-success:hover,
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      }

      .btn-primary:hover {
        box-shadow: 0 6px 20px rgba(0, 102, 178, 0.4);
      }

      .btn-success:active,
      .btn-primary:active {
        transform: translateY(0);
      }

      .btn-block {
        width: 100%;
      }

      /* Monthly Summary Card Styles */
      .monthly-summary-card {
        background: var(--card-bg);
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        transition: all var(--transition-speed) ease;
        animation: fadeIn 0.5s ease;
        border-left: 4px solid var(--primary-color);
      }

      .monthly-summary-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .summary-title {
        font-size: 20px;
        color: var(--text-primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .summary-period {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .summary-period .live-indicator {
        width: 8px;
        height: 8px;
        background: var(--success-color);
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      .summary-table-container {
        overflow-x: auto;
      }

      .summary-table {
        width: 100%;
        border-collapse: collapse;
        animation: tableLoad 0.5s ease;
      }

      .summary-table thead {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
      }

      .summary-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .summary-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
      }

      .summary-table tbody tr:hover {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 102, 178, 0.05),
          transparent
        );
        transform: scale(1.01);
      }

      .summary-table td {
        padding: 12px 15px;
        color: var(--text-primary);
        font-size: 14px;
      }

      .rate-value {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 15px;
      }

      .rate-date {
        font-size: 11px;
        color: var(--text-secondary);
        display: block;
        margin-top: 3px;
      }

      .no-summary-data {
        text-align: center;
        padding: 30px;
        color: var(--text-secondary);
        font-style: italic;
      }

      /* Table Section */
      .table-section {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        transition: all var(--transition-speed) ease;
        animation: fadeIn 1s ease;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .section-title {
        font-size: 22px;
        color: var(--text-primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: color var(--transition-speed) ease;
      }

      .actions-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .refresh-btn,
      .export-btn {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all var(--transition-speed) ease;
        position: relative;
        overflow: hidden;
      }

      .export-btn {
        background: linear-gradient(
          135deg,
          var(--success-color) 0%,
          var(--success-dark) 100%
        );
      }

      .refresh-btn::before,
      .export-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.5s, height 0.5s;
      }

      .refresh-btn:hover::before,
      .export-btn:hover::before {
        width: 200px;
        height: 200px;
      }

      .refresh-btn:hover,
      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 102, 178, 0.3);
      }

      .export-btn:hover {
        box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
      }

      .refresh-btn i {
        transition: transform 0.5s ease;
      }

      .refresh-btn:hover i {
        transform: rotate(360deg);
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        animation: tableLoad 0.5s ease;
      }

      @keyframes tableLoad {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      thead {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
      }

      th::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: white;
        transition: width 0.3s ease;
      }

      th:hover::after {
        width: 100%;
      }

      tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
        animation: rowLoad 0.5s ease;
        animation-fill-mode: backwards;
      }

      tbody tr:hover {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 102, 178, 0.05),
          transparent
        );
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      td {
        padding: 15px;
        color: var(--text-primary);
        transition: color var(--transition-speed) ease;
      }

      .metal-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        animation: badgePop 0.3s ease;
        transition: transform 0.2s ease;
      }

      @keyframes badgePop {
        0% {
          transform: scale(0);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .metal-badge:hover {
        transform: scale(1.1);
      }

      .metal-copper {
        background-color: #e8f4fd;
        color: #0066b2;
      }

      .metal-zinc {
        background-color: #fef3e8;
        color: #f39c12;
      }

      .metal-tin {
        background-color: #e8f8f5;
        color: #16a085;
      }

      .price-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary-color);
        transition: all var(--transition-speed) ease;
      }

      .source-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: transform 0.2s ease;
      }

      .source-badge:hover {
        transform: scale(1.05);
      }

      .source-agosi {
        background-color: #fff3cd;
        color: #856404;
      }

      .source-girm {
        background-color: #d1ecf1;
        color: #0c5460;
      }

      .source-comex {
        background-color: #f8d7da;
        color: #721c24;
      }

      .source-shmet {
        background-color: #d4edda;
        color: #155724;
      }

      .source-brent {
        background-color: #e2e3e5;
        color: #383d41;
      }

      .source-unknown {
        background-color: #f8f9fa;
        color: #6c757d;
      }

      .currency-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: transform 0.2s ease;
      }

      .currency-badge:hover {
        transform: scale(1.05);
      }

      .currency-eur {
        background-color: #e8f4fd;
        color: #004d8c;
      }

      .currency-usd {
        background-color: #e8f8f5;
        color: #16a085;
      }

      .currency-cny {
        background-color: #fef3e8;
        color: #e67e22;
      }

      .currency-gbp {
        background-color: #fce4ec;
        color: #c2185b;
      }

      .currency-other {
        background-color: #f8f9fa;
        color: #6c757d;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        animation: fadeIn 0.5s ease;
      }

      .spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        font-style: italic;
        animation: fadeIn 0.5s ease;
      }

      .text-muted {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 15px;
        transition: color var(--transition-speed) ease;
      }

      .row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .row.align-items-end {
        align-items: flex-end;
      }

      .col-md-4 {
        flex: 1;
        min-width: 200px;
      }

      .pagination-controls {
        margin-top: 15px;
        display: none;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 13px;
        color: var(--text-secondary);
        animation: fadeIn 0.5s ease;
      }

      .pagination-info {
        white-space: nowrap;
      }

      .pagination-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pagination-button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        color: var(--text-primary);
      }

      .pagination-button:hover:not(:disabled) {
        border-color: var(--border-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
        font-size: 14px;
        transition: color var(--transition-speed) ease;
        animation: fadeIn 1.2s ease;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .section-header {
          flex-direction: column;
          gap: 15px;
        }

        .actions-group {
          flex-direction: column;
          width: 100%;
        }

        .refresh-btn,
        .export-btn {
          width: 100%;
          justify-content: center;
        }

        .filters-grid {
          grid-template-columns: 1fr;
        }

        table {
          font-size: 14px;
        }

        th,
        td {
          padding: 10px;
        }

        .pagination-controls {
          flex-direction: column;
          align-items: flex-start;
        }

        .page-tabs {
          flex-direction: column;
        }

        .row {
          flex-direction: column;
        }

        .col-md-4 {
          width: 100%;
        }

        .theme-toggle {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
        }

        /* Monthly Summary responsive */
        .summary-header {
          flex-direction: column;
          gap: 10px;
          align-items: flex-start;
        }

        .summary-table {
          font-size: 12px;
        }

        .summary-table th,
        .summary-table td {
          padding: 8px 10px;
        }
      }

      /* Performance optimizations */
      * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .will-change {
        will-change: transform, opacity;
      }
    </style>
  </head>
  <body>
    <!-- Animated Background Particles -->
    <div class="particles" id="particles"></div>

    <!-- Dark Mode Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
      <i class="fas fa-moon" id="themeIcon"></i>
    </div>

    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <div class="logo-section">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60'%3E%3Ctext x='10' y='40' font-family='Arial' font-size='32' font-weight='bold' fill='%230066b2'%3EAVO%3C/text%3E%3Ctext x='90' y='40' font-family='Arial' font-size='32' fill='%23555'%3ECarbon%3C/text%3E%3Ctext x='110' y='55' font-family='Arial' font-size='14' fill='%23f39c12' font-weight='bold'%3EGROUP%3C/text%3E%3C/svg%3E"
            alt="AVO Carbon Group"
            class="logo"
          />
          <h1 class="header-title">Tableau de Bord</h1>
        </div>
        <div class="last-update">
          <i class="fas fa-clock"></i>
          <span id="lastUpdate">Chargement...</span>
        </div>
      </div>

      <!-- TABS -->
      <div class="page-tabs">
        <button id="tab-metals" class="page-tab active" onclick="showPage('metals')">
          <i class="fas fa-industry"></i> Prix des Métaux
        </button>
        <button id="tab-fx" class="page-tab" onclick="showPage('fx')">
          <i class="fas fa-coins"></i> Taux de change ECB
        </button>
      </div>

      <!-- PAGE MÉTAUX -->
      <div id="page-metals">
        <div class="stats-section">
          <div class="stats-header">
            <h3 class="filters-title">
              <i class="fas fa-chart-line"></i>
              Résumé par métal
            </h3>
            <span id="statsSummary" class="stats-summary">Chargement...</span>
          </div>
          <div class="stats-grid" id="statsContainer"></div>
        </div>

        <div class="filters-section">
          <h3 class="filters-title">
            <i class="fas fa-filter"></i>
            Filtres
          </h3>
          <div class="filters-grid">
            <div class="filter-group" id="filterGroup-metalType">
              <label class="filter-label">Type de métal</label>
              <select
                id="filterMetalType"
                class="filter-select"
                onchange="handleFilterChange()"
              >
                <option value="all">Tous les métaux</option>
              </select>
            </div>

            <div class="filter-group" id="filterGroup-source">
              <label class="filter-label">Source</label>
              <select
                id="filterSource"
                class="filter-select"
                onchange="handleFilterChange()"
              >
                <option value="all">Toutes les sources</option>
              </select>
            </div>

            <div class="filter-group" id="filterGroup-month">
              <label class="filter-label">
                <i class="fas fa-calendar-alt"></i> Filtre par mois
              </label>
              <input
                type="month"
                id="filterMonth"
                class="filter-input"
                onchange="handleFilterChange()"
              />
            </div>

            <div class="filter-group" id="filterGroup-startDate">
              <label class="filter-label">Date de début</label>
              <input
                type="date"
                id="filterStartDate"
                class="filter-input"
                onchange="handleFilterChange()"
              />
            </div>
            <div class="filter-group" id="filterGroup-endDate">
              <label class="filter-label">Date de fin</label>
              <input
                type="date"
                id="filterEndDate"
                class="filter-input"
                onchange="handleFilterChange()"
              />
            </div>

            <div class="filter-group">
              <button class="reset-filters-btn" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Réinitialiser
              </button>
            </div>
          </div>

          <!-- Active Filters Display -->
          <div
            id="activeFiltersContainer"
            class="active-filters"
            style="display: none"
          ></div>
        </div>

        <div class="table-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-table"></i>
              Historique des Prix
            </h2>
            <div class="actions-group">
              <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i>
                Exporter Excel
              </button>
              <button class="refresh-btn" onclick="loadData()">
                <i class="fas fa-sync-alt"></i>
                Actualiser
              </button>
            </div>
          </div>
          <div class="table-container" id="tableContainer">
            <div class="loading">
              <div class="spinner"></div>
              <p>Chargement des données...</p>
            </div>
          </div>
          <div id="paginationControls" class="pagination-controls"></div>
        </div>
      </div>

      <!-- PAGE FX (ECB) - UPDATED WITH MONTHLY SUMMARY -->
      <div id="page-fx" style="display: none">
        <!-- RAPPORT FLORENT -->
        <div class="card" style="border-top: 4px solid #27ae60">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-invoice-dollar"></i> Rapport mensuel
            </h3>
          </div>
          <div class="card-body">
            <p class="text-muted">
              Génère le rapport mensuel avec Closing Rate, Period Rate Average
              (M-1) et Moyenne YTD.
            </p>
            <div class="row align-items-end">
              <div class="col-md-4">
                <label class="filter-label">Choisir le mois :</label>
                <input
                  type="month"
                  id="florent_report_date"
                  class="filter-input"
                  value="2024-11"
                />
              </div>
              <div class="col-md-4">
                <button
                  onclick="downloadFlorentReport()"
                  class="btn-success btn-block"
                >
                  <i class="fas fa-file-excel"></i> Exporter vers Excel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- NEW: MONTHLY SUMMARY DISPLAY -->
        <div class="monthly-summary-card">
          <div class="summary-header">
            <h3 class="summary-title">
              <i class="fas fa-chart-line"></i>
              Résumé Mensuel des Taux
            </h3>
            <div class="summary-period">
              <span class="live-indicator"></span>
              <span id="summaryPeriodText">Chargement...</span>
            </div>
          </div>
          <div class="summary-table-container" id="monthlySummaryContainer">
            <div class="loading">
              <div class="spinner"></div>
              <p>Chargement du résumé mensuel...</p>
            </div>
          </div>
        </div>

        <div class="filters-section">
          <h3 class="filters-title">
            <i class="fas fa-filter"></i>
            Filtres Taux de change ECB (EUR base)
          </h3>
          <div class="filters-grid">
            <div class="filter-group" id="fxFilterGroup-currency">
              <label class="filter-label">Devise cotée (quote_currency)</label>
              <select
                id="fxQuoteCurrency"
                class="filter-select"
                onchange="handleFxFilterChange()"
              >
                <option value="all">Toutes les devises</option>
              </select>
            </div>

            <div class="filter-group" id="fxFilterGroup-month">
              <label class="filter-label">
                <i class="fas fa-calendar-alt"></i> Filtre par mois
              </label>
              <input
                type="month"
                id="fxFilterMonth"
                class="filter-input"
                onchange="handleFxFilterChange()"
              />
            </div>

            <div class="filter-group" id="fxFilterGroup-startDate">
              <label class="filter-label">Date de début</label>
              <input
                type="date"
                id="fxStartDate"
                class="filter-input"
                onchange="handleFxFilterChange()"
              />
            </div>

            <div class="filter-group" id="fxFilterGroup-endDate">
              <label class="filter-label">Date de fin</label>
              <input
                type="date"
                id="fxEndDate"
                class="filter-input"
                onchange="handleFxFilterChange()"
              />
            </div>

            <div class="filter-group">
              <button class="reset-filters-btn" onclick="resetFxFilters()">
                <i class="fas fa-redo"></i> Réinitialiser
              </button>
            </div>
          </div>

          <!-- Active FX Filters Display -->
          <div
            id="fxActiveFiltersContainer"
            class="active-filters"
            style="display: none"
          ></div>
        </div>

        <div class="table-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-coins"></i>
              Détail des Taux de change ECB (EUR → devise)
            </h2>
            <div class="actions-group">
              <button class="export-btn" onclick="exportFxToExcel()">
                <i class="fas fa-file-excel"></i>
                Exporter Excel (FX)
              </button>
              <button class="refresh-btn" onclick="loadFxRates()">
                <i class="fas fa-sync-alt"></i>
                Actualiser (FX)
              </button>
            </div>
          </div>
          <div class="table-container" id="fxTableContainer">
            <div class="loading">
              <div class="spinner"></div>
              <p>Chargement des taux de change ECB...</p>
            </div>
          </div>
          <div id="fxPaginationControls" class="pagination-controls"></div>
        </div>
      </div>

      <div class="footer">
        &copy; 2025 AVO Carbon Group. Tous droits réservés.
      </div>
    </div>

    <script>
      // ==========================================
      // DARK MODE FUNCTIONALITY
      // ==========================================
      function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById("themeIcon");
        const currentTheme = html.getAttribute("data-theme");

        if (currentTheme === "dark") {
          html.removeAttribute("data-theme");
          icon.className = "fas fa-moon";
          localStorage.setItem("theme", "light");
        } else {
          html.setAttribute("data-theme", "dark");
          icon.className = "fas fa-sun";
          localStorage.setItem("theme", "dark");
        }
      }

      // Load saved theme on page load
      window.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme");
        const icon = document.getElementById("themeIcon");

        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          icon.className = "fas fa-sun";
        }

        // Initialize particles
        createParticles();
      });

      // ==========================================
      // ANIMATED PARTICLES
      // ==========================================
      function createParticles() {
        const container = document.getElementById("particles");
        const particleCount = 15;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 20 + "s";
          particle.style.animationDuration = 15 + Math.random() * 10 + "s";
          container.appendChild(particle);
        }
      }

      // ==========================================
      // GLOBAL VARIABLES
      // ==========================================
      let currentFilters = {
        metalType: "all",
        startDate: null,
        endDate: null,
        source: "all",
        month: null,
      };

      let allPrices = [];
      let filteredPrices = [];
      let currentPage = 1;
      const pageSize = 15;

      let fxFilters = {
        quoteCurrency: "all",
        startDate: null,
        endDate: null,
        month: null,
      };
      let fxData = [];
      let fxFilteredData = [];
      let fxCurrentPage = 1;
      const fxPageSize = 15;

      // ==========================================
      // AUTO-APPLY FILTER FUNCTIONS
      // ==========================================
      function handleFilterChange() {
        applyFilters();
      }

      function handleFxFilterChange() {
        applyFxFilters();
      }

      function updateActiveFiltersDisplay() {
        const container = document.getElementById("activeFiltersContainer");
        const badges = [];

        if (currentFilters.metalType && currentFilters.metalType !== "all") {
          const select = document.getElementById("filterMetalType");
          const text = select.options[select.selectedIndex].text;
          badges.push({ key: "metalType", label: `Métal: ${text}` });
          document
            .getElementById("filterGroup-metalType")
            .classList.add("active");
        } else {
          document
            .getElementById("filterGroup-metalType")
            .classList.remove("active");
        }

        if (currentFilters.source && currentFilters.source !== "all") {
          const select = document.getElementById("filterSource");
          const text = select.options[select.selectedIndex].text;
          badges.push({ key: "source", label: `Source: ${text}` });
          document.getElementById("filterGroup-source").classList.add("active");
        } else {
          document
            .getElementById("filterGroup-source")
            .classList.remove("active");
        }

        if (currentFilters.month) {
          badges.push({ key: "month", label: `Mois: ${currentFilters.month}` });
          document.getElementById("filterGroup-month").classList.add("active");
        } else {
          document
            .getElementById("filterGroup-month")
            .classList.remove("active");
        }

        if (currentFilters.startDate) {
          badges.push({
            key: "startDate",
            label: `Début: ${currentFilters.startDate}`,
          });
          document
            .getElementById("filterGroup-startDate")
            .classList.add("active");
        } else {
          document
            .getElementById("filterGroup-startDate")
            .classList.remove("active");
        }

        if (currentFilters.endDate) {
          badges.push({
            key: "endDate",
            label: `Fin: ${currentFilters.endDate}`,
          });
          document.getElementById("filterGroup-endDate").classList.add("active");
        } else {
          document
            .getElementById("filterGroup-endDate")
            .classList.remove("active");
        }

        if (badges.length > 0) {
          container.style.display = "flex";
          container.innerHTML = badges
            .map(
              (badge) => `
                    <div class="filter-badge">
                        <span>${badge.label}</span>
                        <span class="remove-filter" onclick="removeActiveFilter('${badge.key}')">×</span>
                    </div>
                `
            )
            .join("");
        } else {
          container.style.display = "none";
        }
      }

      function updateFxActiveFiltersDisplay() {
        const container = document.getElementById("fxActiveFiltersContainer");
        const badges = [];

        if (fxFilters.quoteCurrency && fxFilters.quoteCurrency !== "all") {
          badges.push({
            key: "quoteCurrency",
            label: `Devise: ${fxFilters.quoteCurrency}`,
          });
          document
            .getElementById("fxFilterGroup-currency")
            .classList.add("active");
        } else {
          document
            .getElementById("fxFilterGroup-currency")
            .classList.remove("active");
        }

        if (fxFilters.month) {
          badges.push({ key: "month", label: `Mois: ${fxFilters.month}` });
          document.getElementById("fxFilterGroup-month").classList.add("active");
        } else {
          document
            .getElementById("fxFilterGroup-month")
            .classList.remove("active");
        }

        if (fxFilters.startDate) {
          badges.push({
            key: "startDate",
            label: `Début: ${fxFilters.startDate}`,
          });
          document
            .getElementById("fxFilterGroup-startDate")
            .classList.add("active");
        } else {
          document
            .getElementById("fxFilterGroup-startDate")
            .classList.remove("active");
        }

        if (fxFilters.endDate) {
          badges.push({ key: "endDate", label: `Fin: ${fxFilters.endDate}` });
          document
            .getElementById("fxFilterGroup-endDate")
            .classList.add("active");
        } else {
          document
            .getElementById("fxFilterGroup-endDate")
            .classList.remove("active");
        }

        if (badges.length > 0) {
          container.style.display = "flex";
          container.innerHTML = badges
            .map(
              (badge) => `
                    <div class="filter-badge">
                        <span>${badge.label}</span>
                        <span class="remove-filter" onclick="removeFxActiveFilter('${badge.key}')">×</span>
                    </div>
                `
            )
            .join("");
        } else {
          container.style.display = "none";
        }
      }

      function removeActiveFilter(filterKey) {
        switch (filterKey) {
          case "metalType":
            document.getElementById("filterMetalType").value = "all";
            currentFilters.metalType = "all";
            break;
          case "source":
            document.getElementById("filterSource").value = "all";
            currentFilters.source = "all";
            break;
          case "month":
            document.getElementById("filterMonth").value = "";
            currentFilters.month = null;
            break;
          case "startDate":
            document.getElementById("filterStartDate").value = "";
            currentFilters.startDate = null;
            break;
          case "endDate":
            document.getElementById("filterEndDate").value = "";
            currentFilters.endDate = null;
            break;
        }
        currentPage = 1;
        loadPriceHistory();
      }

      function removeFxActiveFilter(filterKey) {
        switch (filterKey) {
          case "quoteCurrency":
            document.getElementById("fxQuoteCurrency").value = "all";
            fxFilters.quoteCurrency = "all";
            break;
          case "month":
            document.getElementById("fxFilterMonth").value = "";
            fxFilters.month = null;
            break;
          case "startDate":
            document.getElementById("fxStartDate").value = "";
            fxFilters.startDate = null;
            break;
          case "endDate":
            document.getElementById("fxEndDate").value = "";
            fxFilters.endDate = null;
            break;
        }
        fxCurrentPage = 1;
        loadFxRates();
      }

      // ==========================================
      // UTILITY FUNCTIONS
      // ==========================================
      function formatDate(dateInput) {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return "";
        return date.toLocaleString("fr-FR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatDateOnlyDate(dateInput) {
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return "";
        return date.toLocaleDateString("fr-FR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
      }

      function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) return "--";
        return new Intl.NumberFormat("fr-FR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 4,
        }).format(price);
      }

      function formatSource(sourceUrl) {
        if (!sourceUrl) return { label: "--", class: "source-unknown" };

        const url = String(sourceUrl).trim().toLowerCase();

        if (url.includes("agosi.de")) {
          return { label: "AGOSI", class: "source-agosi" };
        }
        if (url.includes("m-lego.com")) {
          return { label: "GIRM", class: "source-girm" };
        }
        if (url.includes("comexlive.org")) {
          return { label: "COMEX", class: "source-comex" };
        }
        if (url.includes("shmet.com")) {
          return { label: "SHMET", class: "source-shmet" };
        }
        if (url.includes("insee.fr")) {
          return { label: "BRENT LONDON", class: "source-brent" };
        }

        return { label: "AUTRE", class: "source-unknown" };
      }

      // ==========================================
      // METALS FILTERS
      // ==========================================
      function applyFilters() {
        currentFilters.metalType =
          document.getElementById("filterMetalType").value;
        currentFilters.month =
          document.getElementById("filterMonth").value || null;
        currentFilters.startDate =
          document.getElementById("filterStartDate").value || null;
        currentFilters.endDate =
          document.getElementById("filterEndDate").value || null;
        currentFilters.source = document.getElementById("filterSource").value;

        if (currentFilters.month) {
          document.getElementById("filterStartDate").value = "";
          document.getElementById("filterEndDate").value = "";
          currentFilters.startDate = null;
          currentFilters.endDate = null;
        }

        currentPage = 1;
        loadPriceHistory();
      }

      function resetFilters() {
        document.getElementById("filterMetalType").value = "all";
        document.getElementById("filterMonth").value = "";
        document.getElementById("filterStartDate").value = "";
        document.getElementById("filterEndDate").value = "";
        document.getElementById("filterSource").value = "all";

        currentFilters = {
          metalType: "all",
          startDate: null,
          endDate: null,
          source: "all",
          month: null,
        };

        currentPage = 1;
        loadPriceHistory();
      }

      function exportToExcel() {
        let url = "/export/excel?";

        if (currentFilters.metalType !== "all") {
          url += `metal_type=${currentFilters.metalType}&`;
        }
        if (currentFilters.month) {
          url += `month=${currentFilters.month}&`;
        } else {
          if (currentFilters.startDate) {
            url += `start_date=${currentFilters.startDate}&`;
          }
          if (currentFilters.endDate) {
            url += `end_date=${currentFilters.endDate}&`;
          }
          if (!currentFilters.startDate && !currentFilters.endDate) {
            url += "days=30";
          }
        }
        window.location.href = url;
      }

      // ==========================================
      // STATISTICS
      // ==========================================
      async function loadStatistics() {
        try {
          const response = await fetch("/api/statistics");
          const result = await response.json();

          if (result.status === "success") {
            const data = result.data || {};
            const variations = data.variations || [];

            const metalTypes = Array.from(
              new Set(variations.map((v) => v.metal_type))
            ).filter(Boolean);

            const totalRecords = data.total_records || 0;
            const totalMetals = data.total_metals || variations.length || 0;
            const summaryEl = document.getElementById("statsSummary");
            if (summaryEl) {
              summaryEl.textContent = `${totalRecords} enregistrements • ${totalMetals} métaux suivis`;
            }

            const filterSelect = document.getElementById("filterMetalType");
            if (filterSelect.options.length === 1) {
              metalTypes.forEach((type) => {
                const option = document.createElement("option");
                option.value = type.toLowerCase();
                option.textContent = type;
                filterSelect.appendChild(option);
              });
            }

            const container = document.getElementById("statsContainer");
            container.innerHTML = "";

            if (variations.length === 0) {
              container.innerHTML =
                '<div class="no-data">Aucune statistique disponible</div>';
              return;
            }

            variations.forEach((v) => {
              const variation = parseFloat(v.variation_percent);
              const isPositive = variation >= 0;
              const metalLabel = (v.metal_type || "").toUpperCase();
              const currency = v.currency || "CNY";

              const card = document.createElement("div");
              card.className = "stat-card";

              card.innerHTML = `
                <div class="stat-header">
                  <span class="stat-title">${metalLabel}</span>
                  <i class="fas fa-medal stat-icon"></i>
                </div>
                <div class="stat-value">
                  ${
                    v.current_price != null
                      ? formatPrice(v.current_price) + " " + currency
                      : "--"
                  }
                </div>
                <div class="stat-change ${
                  isPositive ? "change-positive" : "change-negative"
                }">
                  <i class="fas fa-arrow-${isPositive ? "up" : "down"}"></i>
                  <span>${
                    isNaN(variation)
                      ? "0"
                      : (isPositive ? "+" : "") + formatPrice(variation)
                  }% (24h)</span>
                </div>
              `;
              container.appendChild(card);
            });
          }
        } catch (error) {
          console.error("Erreur chargement statistiques:", error);
        }
      }

      function populateSourceFilterOptions() {
        const select = document.getElementById("filterSource");
        if (!select) return;

        const currentValue = select.value || "all";
        const labelsSet = new Set();

        allPrices.forEach((price) => {
          const s = formatSource(price.source_url);
          if (s.label && s.label !== "--") {
            labelsSet.add(s.label);
          }
        });

        select.innerHTML = '<option value="all">Toutes les sources</option>';

        Array.from(labelsSet)
          .sort()
          .forEach((label) => {
            const option = document.createElement("option");
            option.value = label.toLowerCase();
            option.textContent = label;
            select.appendChild(option);
          });

        if (currentValue !== "all") {
          const found = Array.from(labelsSet).some(
            (l) => l.toLowerCase() === currentValue.toLowerCase()
          );
          if (found) {
            select.value = currentValue.toLowerCase();
            currentFilters.source = currentValue.toLowerCase();
          }
        }
      }

      function applyTableFiltersAndRender() {
        const tableContainer = document.getElementById("tableContainer");
        const paginationControls =
          document.getElementById("paginationControls");

        if (!Array.isArray(allPrices) || allPrices.length === 0) {
          tableContainer.innerHTML =
            '<div class="no-data">Aucune donnée disponible pour ces filtres</div>';
          if (paginationControls) paginationControls.style.display = "none";
          return;
        }

        const sourceFilter = (currentFilters.source || "all").toLowerCase();

        filteredPrices = allPrices.filter((price) => {
          if (sourceFilter === "all") return true;
          const s = formatSource(price.source_url);
          return (s.label || "").toLowerCase() === sourceFilter;
        });

        if (filteredPrices.length === 0) {
          tableContainer.innerHTML =
            '<div class="no-data">Aucune donnée disponible pour ces filtres</div>';
          if (paginationControls) paginationControls.style.display = "none";
          return;
        }

        const totalPages = Math.ceil(filteredPrices.length / pageSize) || 1;
        if (currentPage > totalPages) currentPage = totalPages;

        renderTablePage(currentPage, totalPages);
      }

      function renderTablePage(page, totalPages) {
        const tableContainer = document.getElementById("tableContainer");
        const paginationControls =
          document.getElementById("paginationControls");

        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredPrices.slice(startIndex, endIndex);
        const totalRecords = filteredPrices.length;

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Produit</th>
                <th>Prix</th>
                <th>Devise</th>
                <th>Unité</th>
                <th>Source</th>
                <th>Date de prix</th>
              </tr>
            </thead>
            <tbody>
        `;

        pageData.forEach((price) => {
          const metalClass = `metal-${
            price.metal_type ? price.metal_type.toLowerCase() : "default"
          }`;
          const source = formatSource(price.source_url);
          const dateValue = price.price_date;

          tableHTML += `
            <tr>
              <td><span class="metal-badge ${metalClass}">${price.metal_type || ""}</span></td>
              <td><span class="price-value">${formatPrice(price.price)}</span></td>
              <td>${price.currency || ""}</td>
              <td>${price.unit || ""}</td>
              <td><span class="source-badge ${source.class}">${source.label}</span></td>
              <td>${dateValue ? formatDateOnlyDate(dateValue) : ""}</td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        tableContainer.innerHTML = tableHTML;

        if (paginationControls) {
          paginationControls.innerHTML = `
            <div class="pagination-info">
              Affichage de ${startIndex + 1} à ${Math.min(
            endIndex,
            totalRecords
          )} sur ${totalRecords} enregistrements
            </div>
            <div class="pagination-buttons">
              <button class="pagination-button" onclick="changePage(${page - 1})" ${
            page <= 1 ? "disabled" : ""
          }>
                &laquo; Précédent
              </button>
              <span>Page ${page} / ${totalPages}</span>
              <button class="pagination-button" onclick="changePage(${page + 1})" ${
            page >= totalPages ? "disabled" : ""
          }>
                Suivant &raquo;
              </button>
            </div>
          `;
          paginationControls.style.display = "flex";
        }
      }

      function changePage(newPage) {
        const totalPages = Math.ceil(filteredPrices.length / pageSize) || 1;
        if (newPage < 1 || newPage > totalPages) return;
        currentPage = newPage;
        renderTablePage(currentPage, totalPages);
      }

      async function loadPriceHistory() {
        try {
          let url = "/api/prices/history?";

          if (currentFilters.metalType !== "all") {
            url += `metal_type=${currentFilters.metalType}&`;
          }
          if (currentFilters.month) {
            url += `month=${currentFilters.month}&`;
          } else {
            if (currentFilters.startDate) {
              url += `start_date=${currentFilters.startDate}&`;
            }
            if (currentFilters.endDate) {
              url += `end_date=${currentFilters.endDate}&`;
            }
          }

          const response = await fetch(url);
          const result = await response.json();

          const tableContainer = document.getElementById("tableContainer");

          if (result.status === "success" && result.data.length > 0) {
            allPrices = result.data;
            populateSourceFilterOptions();
            applyTableFiltersAndRender();
            updateActiveFiltersDisplay();
          } else {
            allPrices = [];
            filteredPrices = [];
            tableContainer.innerHTML =
              '<div class="no-data">Aucune donnée disponible pour ces filtres</div>';
            const paginationControls =
              document.getElementById("paginationControls");
            if (paginationControls) paginationControls.style.display = "none";
            updateActiveFiltersDisplay();
          }
        } catch (error) {
          console.error("Erreur chargement historique:", error);
          document.getElementById("tableContainer").innerHTML =
            '<div class="no-data">Erreur lors du chargement des données</div>';
          const paginationControls =
            document.getElementById("paginationControls");
          if (paginationControls) paginationControls.style.display = "none";
        }
      }

      // ==========================================
      // FX (ECB) FUNCTIONS
      // ==========================================
      function populateFxCurrencyFilter() {
        const select = document.getElementById("fxQuoteCurrency");
        if (!select) return;

        const currentValue = select.value || "all";
        const set = new Set();

        fxData.forEach((row) => {
          if (row.quote_currency) {
            set.add(row.quote_currency);
          }
        });

        select.innerHTML = '<option value="all">Toutes les devises</option>';

        Array.from(set)
          .sort()
          .forEach((code) => {
            const opt = document.createElement("option");
            opt.value = code;
            opt.textContent = code;
            select.appendChild(opt);
          });

        if (currentValue !== "all" && set.has(currentValue)) {
          select.value = currentValue;
          fxFilters.quoteCurrency = currentValue;
        }
      }

      function getCurrencyBadgeClass(code) {
        const c = (code || "").toUpperCase();
        switch (c) {
          case "EUR":
            return "currency-badge currency-eur";
          case "USD":
            return "currency-badge currency-usd";
          case "CNY":
            return "currency-badge currency-cny";
          case "GBP":
            return "currency-badge currency-gbp";
          default:
            return "currency-badge currency-other";
        }
      }

      function renderFxTable() {
        const container = document.getElementById("fxTableContainer");
        const fxPaginationControls = document.getElementById(
          "fxPaginationControls"
        );

        if (!fxData || fxData.length === 0) {
          container.innerHTML = '<div class="no-data">Aucun taux disponible</div>';
          if (fxPaginationControls) fxPaginationControls.style.display = "none";
          return;
        }

        const quoteFilter = fxFilters.quoteCurrency || "all";
        fxFilteredData = fxData.filter((row) => {
          if (!row.quote_currency) return false;
          if (quoteFilter === "all") return true;
          return row.quote_currency === quoteFilter;
        });

        if (fxFilteredData.length === 0) {
          container.innerHTML =
            '<div class="no-data">Aucun taux disponible pour ces filtres</div>';
          if (fxPaginationControls) fxPaginationControls.style.display = "none";
          return;
        }

        const totalPages = Math.ceil(fxFilteredData.length / fxPageSize) || 1;
        if (fxCurrentPage > totalPages) fxCurrentPage = totalPages;

        renderFxTablePage(fxCurrentPage, totalPages);
      }

      function renderFxTablePage(page, totalPages) {
        const container = document.getElementById("fxTableContainer");
        const fxPaginationControls = document.getElementById(
          "fxPaginationControls"
        );

        const startIndex = (page - 1) * fxPageSize;
        const endIndex = startIndex + fxPageSize;
        const pageData = fxFilteredData.slice(startIndex, endIndex);
        const totalRecords = fxFilteredData.length;

        let html = `
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Devise</th>
                <th>Taux</th>
              </tr>
            </thead>
            <tbody>
        `;

        pageData.forEach((row) => {
          const d = row.ref_date ? formatDateOnlyDate(row.ref_date) : "";
          const code = row.quote_currency || "";
          const rate = row.rate != null ? formatPrice(row.rate) : "--";
          const badgeClass = getCurrencyBadgeClass(code);

          html += `
            <tr>
              <td>${d}</td>
              <td><span class="${badgeClass}">${code}</span></td>
              <td>${rate}</td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        container.innerHTML = html;

        if (fxPaginationControls) {
          fxPaginationControls.innerHTML = `
            <div class="pagination-info">
              Affichage de ${startIndex + 1} à ${Math.min(
            endIndex,
            totalRecords
          )} sur ${totalRecords} enregistrements
            </div>
            <div class="pagination-buttons">
              <button class="pagination-button" onclick="changeFxPage(${page - 1})" ${
            page <= 1 ? "disabled" : ""
          }>
                &laquo; Précédent
              </button>
              <span>Page ${page} / ${totalPages}</span>
              <button class="pagination-button" onclick="changeFxPage(${page + 1})" ${
            page >= totalPages ? "disabled" : ""
          }>
                Suivant &raquo;
              </button>
            </div>
          `;
          fxPaginationControls.style.display = "flex";
        }
      }

      function changeFxPage(newPage) {
        const totalPages = Math.ceil(fxFilteredData.length / fxPageSize) || 1;
        if (newPage < 1 || newPage > totalPages) return;
        fxCurrentPage = newPage;
        renderFxTablePage(fxCurrentPage, totalPages);
      }

      function applyFxFilters() {
        fxFilters.quoteCurrency =
          document.getElementById("fxQuoteCurrency").value || "all";
        fxFilters.month =
          document.getElementById("fxFilterMonth").value || null;
        fxFilters.startDate =
          document.getElementById("fxStartDate").value || null;
        fxFilters.endDate =
          document.getElementById("fxEndDate").value || null;

        if (fxFilters.month) {
          document.getElementById("fxStartDate").value = "";
          document.getElementById("fxEndDate").value = "";
          fxFilters.startDate = null;
          fxFilters.endDate = null;
        }

        fxCurrentPage = 1;
        loadFxRates();
      }

      function resetFxFilters() {
        document.getElementById("fxQuoteCurrency").value = "all";
        document.getElementById("fxFilterMonth").value = "";
        document.getElementById("fxStartDate").value = "";
        document.getElementById("fxEndDate").value = "";

        fxFilters = {
          quoteCurrency: "all",
          startDate: null,
          endDate: null,
          month: null,
        };

        fxCurrentPage = 1;
        loadFxRates();
      }

      function exportFxToExcel() {
        let url = "/ecb/rates/export?";

        if (fxFilters.month) {
          url += `month=${fxFilters.month}&`;
        } else {
          if (fxFilters.startDate) {
            url += `start_date=${fxFilters.startDate}&`;
          }
          if (fxFilters.endDate) {
            url += `end_date=${fxFilters.endDate}&`;
          }
        }
        if (fxFilters.quoteCurrency && fxFilters.quoteCurrency !== "all") {
          url += `quote_currency=${fxFilters.quoteCurrency}&`;
        }

        window.location.href = url;
      }

      // ==========================================
      // FLORENT REPORT
      // ==========================================
      function downloadFlorentReport() {
        const picker = document.getElementById("florent_report_date").value;
        if (!picker) {
          alert("Veuillez sélectionner un mois valide.");
          return;
        }
        const [year, month] = picker.split("-");
        window.location.href = `/ecb/export-florent?year=${year}&month=${parseInt(
          month,
          10
        )}`;
      }

      // ==========================================
      // MONTHLY FX SUMMARY FUNCTIONS (NEW)
      // ==========================================
      async function loadMonthlySummary() {
        try {
          const container = document.getElementById("monthlySummaryContainer");
          const periodText = document.getElementById("summaryPeriodText");

          let url = "/ecb/monthly-summary?";

          let year, month;

          if (fxFilters.month) {
            const [y, m] = fxFilters.month.split("-");
            year = parseInt(y, 10);
            month = parseInt(m, 10);
            url += `year=${year}&month=${month}&`;
          } else if (fxFilters.startDate) {
            const date = new Date(fxFilters.startDate);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            url += `year=${year}&month=${month}&`;
          }

          if (fxFilters.quoteCurrency && fxFilters.quoteCurrency !== "all") {
            url += `quote_currency=${fxFilters.quoteCurrency}&`;
          }

          const response = await fetch(url);
          const result = await response.json();

          if (
            result.status === "success" &&
            result.data &&
            result.data.length > 0
          ) {
            const metadata = result.metadata || {};

            if (periodText) {
              const periodStr = metadata.month_name || "Période inconnue";
              const liveText = metadata.is_current_month
                ? " (Données en direct)"
                : "";
              periodText.textContent = periodStr + liveText;
            }

            let html = `
              <table class="summary-table">
                <thead>
                  <tr>
                    <th>Devise</th>
                    <th>Closing Rate<br><small>(${getMonthName(
                      metadata.month
                    )} ${metadata.year})</small></th>
                    <th>Period Rate<br><small>(M-1)</small></th>
                    <th>Average YTD<br><small>(Jan - ${getMonthName(
                      metadata.month
                    )})</small></th>
                  </tr>
                </thead>
                <tbody>
            `;

            result.data.forEach((row) => {
              const currency = row.quote_currency || "";
              const closingRate =
                row.closing_rate != null
                  ? formatPrice(row.closing_rate)
                  : "N/A";
              const closingDate = row.closing_date
                ? formatDateOnlyDate(row.closing_date)
                : "";
              const periodRate =
                row.period_rate != null ? formatPrice(row.period_rate) : "N/A";
              const periodDate = row.period_date
                ? formatDateOnlyDate(row.period_date)
                : "";
              const ytdAvg =
                row.ytd_average != null
                  ? formatPrice(row.ytd_average)
                  : "N/A";

              const badgeClass = getCurrencyBadgeClass(currency);

              html += `
                <tr>
                  <td><span class="${badgeClass}">${currency}</span></td>
                  <td>
                    <span class="rate-value">${closingRate}</span>
                    ${
                      closingDate
                        ? `<span class="rate-date">au ${closingDate}</span>`
                        : ""
                    }
                  </td>
                  <td>
                    <span class="rate-value">${periodRate}</span>
                    ${
                      periodDate
                        ? `<span class="rate-date">au ${periodDate}</span>`
                        : ""
                    }
                  </td>
                  <td>
                    <span class="rate-value">${ytdAvg}</span>
                  </td>
                </tr>
              `;
            });

            html += `
                </tbody>
              </table>
            `;

            container.innerHTML = html;
          } else {
            document.getElementById("monthlySummaryContainer").innerHTML =
              '<div class="no-summary-data">Aucun résumé disponible pour cette période</div>';
            if (document.getElementById("summaryPeriodText")) {
              document.getElementById("summaryPeriodText").textContent =
                "Aucune donnée";
            }
          }
        } catch (error) {
          console.error("Erreur chargement résumé mensuel:", error);
          const container = document.getElementById("monthlySummaryContainer");
          if (container) {
            container.innerHTML =
              '<div class="no-summary-data">Erreur lors du chargement du résumé</div>';
          }
          const periodText = document.getElementById("summaryPeriodText");
          if (periodText) periodText.textContent = "Erreur";
        }
      }

      function getMonthName(monthNum) {
        const months = [
          "Jan",
          "Fév",
          "Mar",
          "Avr",
          "Mai",
          "Jun",
          "Jul",
          "Aoû",
          "Sep",
          "Oct",
          "Nov",
          "Déc",
        ];
        return months[(monthNum || 0) - 1] || "";
      }

      // UPDATED loadFxRates: now loads monthly summary too
      async function loadFxRates() {
        try {
          let url = "/ecb/rates?";

          if (fxFilters.month) {
            url += `month=${fxFilters.month}&`;
          } else {
            if (fxFilters.startDate) {
              url += `start_date=${fxFilters.startDate}&`;
            }
            if (fxFilters.endDate) {
              url += `end_date=${fxFilters.endDate}&`;
            }
          }
          if (fxFilters.quoteCurrency && fxFilters.quoteCurrency !== "all") {
            url += `quote_currency=${fxFilters.quoteCurrency}&`;
          }

          const response = await fetch(url);
          const result = await response.json();

          const container = document.getElementById("fxTableContainer");

          if (
            result.status === "success" &&
            Array.isArray(result.data) &&
            result.data.length > 0
          ) {
            fxData = result.data;
            populateFxCurrencyFilter();
            fxCurrentPage = 1;
            renderFxTable();
            updateFxActiveFiltersDisplay();

            await loadMonthlySummary();
          } else {
            fxData = [];
            fxFilteredData = [];
            container.innerHTML =
              '<div class="no-data">Aucun taux disponible pour ces filtres</div>';
            const fxPaginationControls = document.getElementById(
              "fxPaginationControls"
            );
            if (fxPaginationControls) fxPaginationControls.style.display = "none";
            updateFxActiveFiltersDisplay();

            await loadMonthlySummary();
          }
        } catch (error) {
          console.error("Erreur chargement FX:", error);
          document.getElementById("fxTableContainer").innerHTML =
            '<div class="no-data">Erreur lors du chargement des taux ECB</div>';
          const fxPaginationControls = document.getElementById(
            "fxPaginationControls"
          );
          if (fxPaginationControls) fxPaginationControls.style.display = "none";
        }
      }

      // ==========================================
      // PAGE NAVIGATION
      // ==========================================
      function showPage(page) {
        const metalsPage = document.getElementById("page-metals");
        const fxPage = document.getElementById("page-fx");
        const tabMetals = document.getElementById("tab-metals");
        const tabFx = document.getElementById("tab-fx");

        if (page === "metals") {
          metalsPage.style.display = "block";
          fxPage.style.display = "none";
          tabMetals.classList.add("active");
          tabFx.classList.remove("active");
        } else {
          metalsPage.style.display = "none";
          fxPage.style.display = "block";
          tabMetals.classList.remove("active");
          tabFx.classList.add("active");
        }
      }

      // ==========================================
      // MAIN DATA LOADING (UPDATED)
      // ==========================================
      async function loadData() {
        document.getElementById("lastUpdate").textContent =
          "Mise à jour en cours...";

        await Promise.all([loadStatistics(), loadPriceHistory(), loadFxRates()]);

        document.getElementById("lastUpdate").textContent = formatDate(new Date());
      }

      // ==========================================
      // INITIALIZATION
      // ==========================================
      showPage("metals");
      loadData();
      setInterval(loadData, 5 * 60 * 1000); // Auto-refresh every 5 minutes
    </script>
  </body>
</html>
